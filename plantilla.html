export default defineComponent({
    async run({ steps, $ }) {
      // --- CONFIGURACIÓN REQUERIDA: ¡YA ACTUALIZADA CON TUS DATOS! ---
      const NETLIFY_BASE_URL = "https://es.hgaruna.org"; 
      const ARTICLES_SUBFOLDER = ""; // Los artículos van en la raíz
      // --- FIN DE CONFIGURACIÓN ---
  
      // ====================================================================
      // PARTE 1: GENERACIÓN DEL ARTÍCULO HTML
      // ====================================================================
  
      let geminiRawOutput = steps.generate_content_from_text.$return_value.candidates[0].content.parts[0].text;
      
      if (!geminiRawOutput || typeof geminiRawOutput !== 'string' || geminiRawOutput.trim() === '') {
          console.error("La salida de Gemini es inválida o vacía. Deteniendo el flujo.");
          $.flow.exit("No se pudo obtener contenido válido de Gemini."); 
          return; 
      }
  
      let geminiParsedContent;
      let articleData = {}; 
  
      try {
          geminiParsedContent = JSON.parse(geminiRawOutput);
          
          if (geminiParsedContent && typeof geminiParsedContent === 'object' && geminiParsedContent.article && typeof geminiParsedContent.article === 'object') {
              articleData = geminiParsedContent.article;
          } else {
              console.warn("Gemini output fue JSON válido, pero la propiedad 'article' no se encontró o estaba malformada.");
              articleData = { 
                  title: "Artículo Generado", 
                  subtitle: "Contenido inesperado de Gemini.", 
                  content: geminiRawOutput 
              };
          }
      } catch (e) {
          console.error("Error al parsear el JSON de Gemini. Asumiendo que el output es solo el contenido:", e);
          articleData = { 
              title: "Artículo Generado", 
              subtitle: "Error en formato de salida de Gemini.", 
              content: geminiRawOutput 
          };
      }
  
      // --- LÓGICA PARA EXTRAER TÍTULO Y SUBTÍTULO DEL CONTENIDO Y LIMPIAR EL CUERPO ---
      let tituloArticulo = "Sin Título";
      let subtituloArticulo = "Sin Subtítulo";
      let contenidoArticulo = articleData.content || "Contenido no disponible.";
  
      const h1Regex = /<h1[^>]*>(.*?)<\/h1>/s;
      const h1Match = contenidoArticulo.match(h1Regex);
      if (h1Match && h1Match[1]) {
          tituloArticulo = h1Match[1].trim();
          contenidoArticulo = contenidoArticulo.replace(h1Regex, '').trim();
      }
  
      const h2Regex = /<h2[^>]*>(.*?)<\/h2>/s;
      const h2Match = contenidoArticulo.match(h2Regex); 
      if (h2Match && h2Match[1]) {
          subtituloArticulo = h2Match[1].trim();
          contenidoArticulo = contenidoArticulo.replace(h2Regex, '').trim();
      }
  
      // --- FUNCIÓN PARA CREAR EL SLUG ACORTADO ---
      const createSlug = (text) => {
          if (!text) return 'articulo';
          return text
              .toString()
              .normalize('NFD') 
              .replace(/[\u0300-\u036f]/g, '') 
              .toLowerCase() 
              .trim() 
              .replace(/\s+/g, '-') 
              .replace(/[^\w-]+/g, '') 
              .replace(/--+/g, '-') 
              .substring(0, 50); // Reducido de 80 a 50 caracteres
      };
  
      // --- FUNCIÓN PARA ACORTAR TÍTULO ---
      const shortenTitle = (title, maxLength = 60) => {
          if (!title || title.length <= maxLength) return title;
          return title.substring(0, maxLength).trim() + '...';
      };
  
      // --- FUNCIÓN PARA GENERAR META DESCRIPCIÓN ---
      const generateMetaDescription = (content, maxLength = 160) => {
          // Remover HTML tags y limpiar contenido
          const cleanContent = content.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim();
          if (cleanContent.length <= maxLength) return cleanContent;
          return cleanContent.substring(0, maxLength).trim() + '...';
      };
  
      // --- FUNCIÓN PARA EXTRAER PALABRAS CLAVE ---
      const extractKeywords = (title, content) => {
          const allText = (title + ' ' + content).toLowerCase();
          const words = allText.replace(/[^\w\s]/g, '').split(/\s+/);
          const wordCount = {};
          
          words.forEach(word => {
              if (word.length > 3) { // Solo palabras de más de 3 caracteres
                  wordCount[word] = (wordCount[word] || 0) + 1;
              }
          });
          
          // Obtener las 10 palabras más frecuentes
          const keywords = Object.entries(wordCount)
              .sort(([,a], [,b]) => b - a)
              .slice(0, 10)
              .map(([word]) => word);
          
          return keywords.join(', ');
      };
  
      const hoy = new Date();
      const fechaFormateada = hoy.toLocaleDateString('es-AR', { year: 'numeric', month: 'long', day: 'numeric' });
      
      // Acortar título para el archivo
      const tituloCorto = shortenTitle(tituloArticulo, 40);
      const articleSlug = createSlug(tituloCorto);
      const year = hoy.getFullYear();
      const month = String(hoy.getMonth() + 1).padStart(2, '0');
      const day = String(hoy.getDate()).padStart(2, '0');
      const nombreArchivo = `${articleSlug}-${year}-${month}-${day}.html`; 
  
      // Generar meta tags
      const metaTitle = shortenTitle(tituloArticulo, 60);
      const metaDescription = generateMetaDescription(contenidoArticulo);
      const metaKeywords = extractKeywords(tituloArticulo, contenidoArticulo);
  
      contenidoArticulo = contenidoArticulo
          .replace(/^\\n+|\\n+$/g, '') 
          .replace(/\\n\\n/g, '</p><p>') 
          .replace(/\\n/g, '<br>');      
  
      if (!contenidoArticulo.trim().startsWith('<') && contenidoArticulo.trim() !== '') {
          contenidoArticulo = '<p>' + contenidoArticulo + '</p>';
      } else if (contenidoArticulo.trim() === '') {
          contenidoArticulo = '<p>Contenido del artículo no disponible.</p>'; 
      }
  
      const htmlFinal = `
      <!DOCTYPE html>
  <html lang="es">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>${metaTitle}</title>
      <meta name="description" content="${metaDescription}">
      <meta name="keywords" content="${metaKeywords}">
      <meta name="author" content="HGARUNA News">
      <meta name="robots" content="index, follow">
      <meta property="og:title" content="${metaTitle}">
      <meta property="og:description" content="${metaDescription}">
      <meta property="og:type" content="article">
      <meta property="og:url" content="${NETLIFY_BASE_URL}/${nombreArchivo}">
      <meta name="twitter:card" content="summary">
      <meta name="twitter:title" content="${metaTitle}">
      <meta name="twitter:description" content="${metaDescription}">
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
      <link rel="stylesheet" href="../main.css" />
      <link href="https://fonts.googleapis.com/css?family=Montserrat:400,500,700&display=swap" rel="stylesheet" />
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
      <style>
          body { 
              font-family: 'Montserrat', sans-serif; 
              background: linear-gradient(135deg, #1e3a8a, #3b82f6);
              color: #333; 
              line-height: 1.8; 
          }
          .static-container { 
              max-width: 900px; 
              margin: 40px auto; 
              background: #fff; 
              padding: 40px; 
              border-radius: 15px; 
              box-shadow: 0 8px 32px rgba(0,0,0,0.1);
              border: 2px solid rgba(255, 255, 255, 0.2);
          }
          .static-header {
              text-align: center;
              margin-bottom: 40px;
              padding-bottom: 30px;
              border-bottom: 3px solid #bfa046;
          }
          .static-title { 
              color: #1e3a8a; 
              font-size: 2.8em; 
              font-weight: 800;
              margin-bottom: 15px;
              text-shadow: 0 2px 4px rgba(0,0,0,0.1);
          }
          .static-subtitle {
              color: #6c757d;
              font-size: 1.2em;
              font-weight: 500;
          }
          .static-content h2 { 
              color: #1e3a8a; 
              border-bottom: 2px solid #bfa046; 
              padding-bottom: 10px; 
              margin-top: 40px; 
              font-size: 1.8em; 
              font-weight: 700;
          }
          .static-content h3 { 
              color: #3b82f6; 
              margin-top: 25px; 
              font-size: 1.4em; 
              font-weight: 600;
          }
          .static-content p { 
              margin-bottom: 20px; 
              text-align: justify; 
              font-size: 1.1em;
              line-height: 1.8;
          }
          .static-divider { 
              border: 0; 
              height: 2px; 
              background: linear-gradient(90deg, #bfa046, #3b82f6); 
              margin: 40px 0; 
              border-radius: 1px;
          }
          .static-footer { 
              text-align: center; 
              margin-top: 50px; 
              padding-top: 30px;
              border-top: 2px solid #e9ecef;
              font-size: 0.95em; 
              color: #6c757d;
          }
          .static-badge {
              display: inline-block;
              background: linear-gradient(135deg, #bfa046, #d4af37);
              color: white;
              padding: 8px 16px;
              border-radius: 20px;
              font-size: 0.9em;
              font-weight: 600;
              margin: 10px 5px;
          }
          .static-highlight {
              background: linear-gradient(135deg, rgba(191, 160, 70, 0.1), rgba(59, 130, 246, 0.1));
              padding: 20px;
              border-radius: 10px;
              border-left: 4px solid #bfa046;
              margin: 20px 0;
          }
          @media (max-width: 768px) {
              .static-container { 
                  margin: 20px; 
                  padding: 25px; 
              }
              .static-title { 
                  font-size: 2.2em; 
              }
              .static-content h2 { 
                  font-size: 1.6em; 
              }
          }
      </style>
  </head>
  <body>
      <div class="static-container">
          <div class="static-header">
              <h1 class="static-title">
                  <i class="bi bi-newspaper"></i> ${tituloArticulo}
              </h1>
              <p class="static-subtitle">
                  <i class="bi bi-calendar3"></i> ${subtituloArticulo}
              </p>
              <div>
                  <span class="static-badge">
                      <i class="bi bi-robot"></i> Generado por IA
                  </span>
                  <span class="static-badge">
                      <i class="bi bi-clock"></i> ${hoy.toLocaleDateString('es-AR', { hour: '2-digit', minute: '2-digit' })}
                  </span>
              </div>
          </div>
          
          <div class="static-divider"></div>
          
          <div class="static-content">
              <div class="static-highlight">
                  <h3><i class="bi bi-lightbulb"></i> Análisis Inteligente</h3>
                  <p>Este contenido ha sido analizado y procesado por inteligencia artificial para proporcionar insights relevantes y contextualizados.</p>
              </div>
              
              <div>
                  ${contenidoArticulo}
              </div>
          </div>
          
          <div class="static-divider"></div>
          
          <div class="static-footer">
              <p>
                  <i class="bi bi-gear-fill"></i> Generado automáticamente por Pipedream con Gemini AI
              </p>
              <p>
                  <i class="bi bi-shield-check"></i> HGARUNA News - Tu Periódico Digital
              </p>
          </div>
      </div>
  </body>
  </html>
      `;
  
      $.export("contenido_html", htmlFinal);
      $.export("nombre_archivo", nombreArchivo);
  
      // ====================================================================
      // PARTE 2: GENERACIÓN DEL SITEMAP.XML (AÑADIR NUEVA URL)
      // ====================================================================
  
      // Leer el sitemap existente si existe
      let existingSitemap = '';
      try {
          // Intentar leer el sitemap existente
          const fs = require('fs');
          if (fs.existsSync('sitemap.xml')) {
              existingSitemap = fs.readFileSync('sitemap.xml', 'utf8');
          }
      } catch (error) {
          console.log('No se pudo leer el sitemap existente, creando uno nuevo');
      }
  
      const articlePath = ARTICLES_SUBFOLDER ? `${ARTICLES_SUBFOLDER}/${nombreArchivo}` : nombreArchivo;
      const articleUrl = `${NETLIFY_BASE_URL}/${articlePath}`;
      const lastMod = new Date().toISOString(); 
  
      let sitemapContent;
      
      if (existingSitemap && existingSitemap.includes('<urlset')) {
          // Añadir nueva URL al sitemap existente
          const newUrlEntry = `
    <url>
      <loc>${articleUrl}</loc>
      <lastmod>${lastMod}</lastmod>
      <changefreq>daily</changefreq>
      <priority>0.8</priority>
    </url>`;
          
          // Insertar antes del cierre de </urlset>
          sitemapContent = existingSitemap.replace('</urlset>', `${newUrlEntry}\n  </urlset>`);
      } else {
          // Crear nuevo sitemap si no existe
          sitemapContent = `<?xml version="1.0" encoding="UTF-8"?>
  <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
    <url>
      <loc>${NETLIFY_BASE_URL}/</loc>
      <lastmod>${lastMod}</lastmod>
      <changefreq>daily</changefreq>
      <priority>1.0</priority>
    </url>
    <url>
      <loc>${articleUrl}</loc>
      <lastmod>${lastMod}</lastmod>
      <changefreq>daily</changefreq>
      <priority>0.8</priority>
    </url>
  </urlset>`;
      }
  
      $.export("sitemap_content", sitemapContent);
      $.export("sitemap_filename", "sitemap.xml");
    },
  });